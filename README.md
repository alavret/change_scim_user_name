# Изменение имени пользователя в Yandex 360 через SCIM API

## Обзор

Скрипт `change_username.py` предназначен для управления именами пользователей (атрибут `userName`) в Yandex 360 с использованием SCIM API. Он позволяет загружать текущие данные пользователей, формировать новые имена пользователей на основе заданного формата и обновлять их в Yandex 360. Скрипт работает с CSV-файлом (определяется через файл параметров, по умолчанию - `users.csv`) и предоставляет интерактивное меню для выполнения операций.

> [!NOTE]
> Обновление атрбута userName через SCIM API в Yandex 360 необходимо в случае, если у пользователя меняется атрибут, используемый для создания имени входа пользователя в Yandex 360 (и которое совпадает с атрибутом NameID в SAMLResponse от SAML провайдера). Если в AD меняется такой исходный атрибут для уже существующего в Yandex 360 пользователя, средство синхронизации блокирует такого пользователя и у него нет возможности подключиться через SAML провайдер к своей учётной записи в Yandex 360. Смена userName помогает в таком случае. Дополнительная информация в [статье на Хабре](https://habr.com/ru/companies/yandex360/articles/795483/) (раздел "Переименование пользователя в Active Directory").

## Логика работы

1. **Загрузка настроек**:
   - Читает параметры из файла `.env` (токен, ID домена, имя файла пользователей, формат нового имени пользователя).
   - Проверяет наличие обязательных параметров (`SCIM_TOKEN_ARG`, `SCIM_DOMAIN_ID_ARG`, `USERS_FILE_ARG`).

2. **Интерактивное меню**:
   - **Опция 1**: Установить шаблон формирования нового значения userName (по умолчанию `alias@domain.tld`).
   - **Опция 2**: Загрузить данные пользователей из Yandex 360 с помощью SCIM API и сохранить в CSV-файл.
   - **Опция 3**: Обновить атрибут userName через SCIM API в Yandex 360 на основе данных из CSV-файла.
   - **Опция 0**: Выход.

3. **Загрузка пользователей (Опция 2)**:
   - Выполняет GET-запросы к SCIM API (`/v2/Users`) для получения текущего значения параметра userName для всех пользователей организации с пагинацией (100 записей за запрос).
   - Формирует новое значение userName, применяя шаблон замены, по умолчанию определённый через параметр  NEW_LOGIN_DEFAULT_FORMAT_ARG или установленный вручную (например, заменяет `alias`, `domain`, `tld`).
   - Сохраняет данные в CSV-файл (`users.csv`) с полями: `uid`, `displayName`, `old_userName`, `new_userName`.

4. **Обновление пользователей (Опция 3)**:
   - Читает CSV-файл, пропуская строки с некорректным `uid` или пустым `new_userName`.
   - Пропускает пользователей, у которых `old_userName` совпадает с `new_userName`.
   - Запрашивает подтверждение перед изменением.
   - Выполняет PATCH-запросы к SCIM API для обновления `userName` с тремя попытками при ошибках (задержка 2 секунды между попытками).

5. **Логирование**:
   - Логирует операции в консоль (уровень INFO) и в файл `change_scim_user_name.log` (уровень DEBUG).
   - Ротация логов происходит при достижении 10 МБ, хранится до 5 резервных копий.

## Параметры

Скрипт использует переменные окружения, задаваемые в файле `.env` в каталоге скрипта или непосредственно в окружении:

| Имя параметра                     | Описание                                                                 | Обязательный | Пример значения                  |
|-----------------------------------|--------------------------------------------------------------------------|--------------|----------------------------------|
| `SCIM_TOKEN_ARG`                  | OAuth-токен для аутентификации в SCIM API Yandex 360.                    | Да           | `y0_AgAAAAAAAAAAAA`            |
| `SCIM_DOMAIN_ID_ARG`              | Идентификатор домена в Yandex 360 (целочисленный).                       | Да           | `1234567`                        |
| `USERS_FILE_ARG`                  | Имя CSV-файла с данными пользователей.                                   | Да           | `users.csv`                      |
| `NEW_LOGIN_DEFAULT_FORMAT_ARG`    | Шаблон нового имени пользователя (подстановки: `alias`, `domain`, `tld`). | Нет (по умолчанию `alias@domain.tld`) | `alias@domain.ru` |

> [!WARNING]
> Параметр Domain ID отличается от параметра Organization ID, который используется в Яндекс 360 API. Параметр Domain ID можно узнать из настроек SSO в консоли администрирования организации Яндекс 360.

> [!NOTE]
> SCIM OAuth токен и Domain ID проще всего взять из параметров конфигурации утилиты SCIM для синхронизации пользователей локальной AD в Яндекс 360 (находится по пути `C:\ProgramData\Yandex\YandexADSCIM\AD_Users.config` на компьютере, где установлена утилита синхронизации SCIM). 

### Формат CSV-файла
CSV-файл (`users.csv`) должен содержать следующие столбцы (разделитель `;`):

| Поле            | Описание                                              | Обязательное | Пример значения           |
|-----------------|-------------------------------------------------------|--------------|---------------------------|
| `uid`           | Уникальный идентификатор пользователя в Yandex 360.   | Да           | `1130000069123456`        |
| `displayName`   | Отображаемое имя пользователя.                        | Нет          | `Иванов Иван`             |
| `old_userName`  | Текущее имя пользователя (email).                     | Да           | `ivan@contoso.com`        |
| `new_userName`  | Новое имя пользователя (email).                       | Да           | `ivan@contoso.ru`         |

**Пример файла `users.csv`**:
```
uid;displayName;old_userName;new_userName
1130000069123456;Иванов Иван;ivan@contoso.com;ivan@contoso.ru
1130000069123457;Петров Петр;petr@contoso.com;petr@contoso.ru
1130000069123458;Мария Семенова;maria@contoso.com;maria@contoso.ru
1130000069123459;;;irina@contoso.ru
```
> [!NOTE]
> Файл всегда первой строкой должен содержать список полей - `uid;displayName;old_userName;new_userName`. Чтение строк с данными для изменения начинается со второй строки.

> Для использования файла как списка входных значений, обязательными параметрами являются поля `uid` и `new_userName`. Остальные поля можно оставить пустыми, но они должны быть отделены точкой с запятой. При этом из всех строк будут использованы только те строки, где old_userName <> new_userName (если old_userName заполнен).

### Примечания к параметрам
- **Обязательные параметры**: `SCIM_TOKEN_ARG`, `SCIM_DOMAIN_ID_ARG`, `USERS_FILE_ARG` должны быть заданы, иначе скрипт завершится с ошибкой.
- **NEW_LOGIN_DEFAULT_FORMAT_ARG**: Используется для автоматического формирования `new_userName` из существующего userName при загрузке пользователей. Подстановки:
  - `alias`: Логин до `@` (например, `ivan` из `ivan@contoso.com`).
  - `domain`: Доменная часть без TLD (все, что после `@` и до последней точки, например, `mail.contoso` из `mail.contoso.com`).
  - `tld`: TLD (все, что после последней точки, например, `com` из `contoso.com`).
- **Файл `.env`**: Пример:
  ```
  SCIM_TOKEN_ARG=y0_AgAAAAAAAAAAAA
  SCIM_DOMAIN_ID_ARG=1234567
  USERS_FILE_ARG=users.csv
  NEW_LOGIN_DEFAULT_FORMAT_ARG=alias@domain.ru
  ```

## Примеры использования шаблона `alias@domain.tld`
Формат `NEW_LOGIN_DEFAULT_FORMAT_ARG` определяет, как формируется новое имя пользователя из старого. Примеры подстановки:

| Старое имя пользователя (`old_userName`) | Формат (`NEW_LOGIN_DEFAULT_FORMAT_ARG`) | Новое имя пользователя (`new_userName`) |
|-----------------------------------------|----------------------------------------|----------------------------------------|
| `ivan@contoso.com`                      | `alias@domain.ru`                      | `ivan@contoso.ru`                      |
| `petr@sub.contoso.com`                  | `alias@domain.ru`                      | `petr@sub.contoso.ru`                  |
| `maria@contoso.co.uk`                   | `alias@newdomain.com`                  | `maria@newdomain.com`                    |
| `john.doe@company.org`                  | `alias@domain.tld`                     | `john.doe@company.org`                 |

**Пояснение**:
- Для `ivan@contoso.com` с форматом `alias@domain.ru`:
  - `alias = ivan`, `domain = contoso`, `tld = com` (не используется) → `ivan@contoso.ru`.
- Для `petr@sub.contoso.com` с форматом `alias@domain.ru`:
  - `alias = petr`, `domain = sub.contoso`, `tld = com` (не используется) → `petr@sub.contoso.ru`.

## Установка

1. **Установите Python**: Требуется Python 3.7 или выше.
2. **Установите зависимости**:
   Скрипт требует библиотеки:
   - `python-dotenv`: Для загрузки переменных окружения.
   - `requests`: Для HTTP-запросов к SCIM API.
   - `http`: Для обработки ошибок вызовов SCIM API

   Установите их с помощью:
   ```bash
   pip install python-dotenv requests http
   ```

3. **Настройте окружение**:
   - Создайте файл `.env` в каталоге скрипта с параметрами (см. пример выше).
   - Подготовьте CSV-файл (`users.csv`), если планируется обновление пользователей.
   - Убедитесь, что у вас есть действующий SCIM OAuth-токен и Domain ID Yandex 360.

## Запуск

1. **Подготовка**:
   - Поместите скрипт `change_username.py` и файл `.env` в рабочий каталог.
   - Убедитесь, что CSV-файл (`users.csv`) существует, если используется опция 3.

2. **Запуск скрипта**:
   ```bash
   python change_username.py
   ```
   Скрипт откроет интерактивное меню:
   - **1**: Установить шаблон для генерации нового userName из текущего значения userName в SCIM API для пользователя (например, `alias@domain.ru`).
   - **2**: Загрузить пользователей из Yandex 360 в `users.csv`.
   - **3**: Обновить userName на основе `users.csv` (требуется подтверждение).
   - **0**: Выход.

3. **Пример работы**:
   - Выберите `2` для загрузки пользователей:
     ```bash
     python change_username.py
     # Выберите 2
     ```
     Скрипт создаст `users.csv` с текущими данными пользователей.
   - Отредактируйте `users.csv`, указав новые userName в столбце `new_userName`.
   - Выберите `3` для обновления:
     ```bash
     python change_username.py
     # Выберите 3, подтвердите (Y)
     ```
     Скрипт обновит `userName` для выбранных пользователей.

## Логирование

- **Консоль**: Сообщения уровня INFO (например, `2023-10-01 12:00:00.123 INFO: Изменён пользователь ivan@contoso.com на ivan@contoso.ru`).
- **Файл**: Сообщения уровня DEBUG записываются в `change_scim_user_name.log`, ротация при 1 МБ (5 копий).
- Формат: `%(asctime)s.%(msecs)03d %(levelname)s:\t%(message)s` с датой `ГГГГ-ММ-ДД ЧЧ:ММ:СС`.

## Обработка ошибок

- **Отсутствие параметров**: Если `SCIM_TOKEN_ARG`, `SCIM_DOMAIN_ID_ARG` или `USERS_FILE_ARG` не заданы, скрипт завершается с ошибкой.
- **Ошибки API**: Обрабатываются с тремя попытками (задержка 2 секунды). При неудаче логируется ошибка.
- **Некорректный CSV**: Пропускаются строки с неверным `uid`, пустым `new_userName` или неправильным количеством полей.
- **Совпадение имён**: Пользователи, у которых `old_userName` равно `new_userName`, пропускаются.

## Ограничения

- Поддерживается только SCIM API Yandex 360 (URL: `https://{DomainId}.scim-api.passport.yandex.net/`).
- CSV-файл должен иметь строго 4 столбца с разделителем `;`.
- Новый userName может быть любым уникальным значением (не только в формате email адреса). При этом значение этого атрибута должно быть согласовано с настройками утилиты SCIM (поле PropertyLoginName) и с значеним, возвращаемым SAML провайдером в атрибуте NаmeID в SAMLResponse при аутентфиикации в Яндекс 360 через SSO. 
- Для большого количества пользователей запрос выгрузки пользователей может занимать десятки минут.

